# 디지털화환 프로젝트 - 오류 해결 기록 (현재 진행 중)

> 이 문서는 **현재 진행 중인** 오류만 표시합니다.
> 해결된 오류는 자동으로 [archive/오류해결-2026-01-archived.md](./archive/오류해결-2026-01-archived.md)로 이동됩니다.

**마지막 업데이트**: 2026-01-12

---

## 📋 현재 상태

**🎉 현재 진행 중인 오류가 없습니다!**

마지막 해결된 오류:
- **오류 #15**: Remotion "Target Closed" 에러 → ✅ 해결 완료 (2026-01-11)
- **오류 #16**: Remotion 렌더링 속도 & ResultStep 메모리 크래시 → ✅ 해결 완료 (2026-01-11)
- **오류 #17**: 영상 버벅임 문제 (VFR → CFR 변환) → ✅ 해결 완료 (2026-01-12)

---

## 최근 해결된 오류 (2026-01-11)

### 오류 #15: Remotion "Target Closed" 에러 (메모리 크래시) ✅

**발생일**: 2026-01-11
**완료일**: 2026-01-11
**파일**: `render-text-overlay/route.ts`, `temp-video/[id]/route.ts`
**상태**: ✅ 해결 완료 (테스트 성공)

#### 오류 메시지
```
Protocol error (Page.addScriptToEvaluateOnNewDocument): Target closed.
https://www.remotion.dev/docs/target-closed
```

**터미널 로그**:
```
Starting Remotion text overlay rendering with 6 texts
Using Base64 video data URL directly for Remotion
Bundling Remotion composition...
Bundle created: C:\Users\jayit\AppData\Local\Temp\remotion-webpack-bundle-4Nk9OO
Remotion Rendering Error: [Error [ProtocolError]: Protocol error...
POST /api/ai/render-text-overlay 500 in 16595ms
```

#### 원인

**Puppeteer/Chrome 브라우저 메모리 크래시**:

1. **Base64 비디오 크기 문제**
   - 30초 1080x1080 영상 = 5-15MB
   - Base64 인코딩 → 33% 증가 = 7-20MB
   - Chrome이 거대한 Data URL 처리 실패

2. **Remotion Video 컴포넌트 제약**
   - `<Video src="data:video/mp4;base64,..." />`
   - Chrome이 Base64를 메모리에 전체 로드 시도
   - 메모리 부족 → 프로세스 종료 (16초 후 크래시)

3. **Vercel 서버리스 메모리 제한**
   - Chrome + Remotion + 대용량 Base64 = 메모리 초과

#### 해결 방법

**임시 HTTP 서버로 파일 제공**:

**전략**:
1. Base64 → 임시 파일 저장 (`os.tmpdir()`)
2. Next.js API route로 파일 스트리밍 제공
3. Remotion에 HTTP URL 전달: `http://localhost:3000/api/temp-video/remotion_input_12345.mp4`
4. Chrome이 HTTP 스트리밍으로 비디오 로드 (메모리 효율적)

**구현 완료**:
1. ✅ `src/app/api/temp-video/[id]/route.ts` (신규 생성)
   - GET 요청으로 임시 파일 스트리밍
   - `Content-Type: video/mp4` 헤더 설정
   - 보안: `remotion_input_*.mp4` 패턴만 허용

2. ✅ `src/app/api/ai/render-text-overlay/route.ts` (수정)
   - Base64 → 임시 파일 저장
   - HTTP URL 생성하여 Remotion에 전달
   - 렌더링 완료 후 임시 파일 삭제

**결과**:
- ✅ Chrome 메모리 부담 감소 (스트리밍 방식)
- ✅ "Target closed" 에러 완전 해결
- ✅ 안정적인 30초 영상 렌더링 성공 (15분 소요 → 대폭 단축)

**테스트 완료**: 정상 작동 확인 ✅

#### 상세 정보

자세한 수정 과정은 [archive/error-fix-remotion-target-closed.md](./archive/error-fix-remotion-target-closed.md) 참고

---

### 오류 #16: Remotion 렌더링 속도 & ResultStep 메모리 크래시 ✅

**발생일**: 2026-01-11
**완료일**: 2026-01-11
**파일**: `render-text-overlay/route.ts`, `ResultStep.tsx`
**상태**: ✅ 해결 완료

#### 문제점

1. **렌더링 속도**: 15분 소요 (Vercel 5분 제한 초과)
2. **브라우저 크래시**: "텍스트 오버레이 적용하기" 버튼 클릭 시 "페이지를 표시할 수 없음"

#### 해결 방법

**성능 최적화**:
1. ✅ 번들 캐싱 구현 (두 번째 요청부터 3-5분 절약)
2. ✅ Concurrency 최적화 (4로 고정)
3. ✅ 비트레이트 감소 (3M)
4. ✅ FPS 감소 (24)

**메모리 크래시 수정**:
- Base64 → Blob 변환
- JSON → FormData 전송
- multipart/form-data 지원 추가

**결과**:
- ✅ 렌더링 시간 대폭 단축
- ✅ 브라우저 크래시 없음
- ✅ 페이지 안정성 확보

#### 상세 정보

자세한 최적화 과정은 [archive/remotion-performance-optimization.md](./archive/remotion-performance-optimization.md) 참고

---

## 최근 해결된 오류 (2026-01-12)

### 오류 #17: 영상 버벅임 문제 (VFR → CFR 변환) ✅

**발생일**: 2026-01-12
**완료일**: 2026-01-12
**파일**: `loop-video/route.ts`
**상태**: ✅ 해결 완료

#### 문제 상황

**증상**:
- AI 생성 홀로그램 영상에서 지속적인 버벅임(lag/stutter) 발생
- 루프 지점뿐만 아니라 전체 영상에서 미세한 끊김 현상
- 30fps로 설정했음에도 프레임 드랍/스킵 발생

**근본 원인**: "Frankenstein Video" 문제
1. AI 생성 비디오가 **Variable Frame Rate (VFR)** 사용
2. `loop-video/route.ts`에서 `-c copy` 사용으로 VFR 그대로 보존
3. concat 시 VFR + CFR 비디오 혼합으로 타임베이스 충돌
4. Remotion이 CFR 30fps를 기대하지만 VFR 소스로 인한 렌더링 충돌

#### 해결 방법: "Sanitize First" 전략

**핵심**: AI 원본 비디오를 먼저 CFR 30fps로 표준화한 후 모든 처리 진행

**수정 내용**:
1. **Step 0 (신규)**: 원본을 CFR 30fps + GOP 30으로 표준화
2. **Step 1 (수정)**: 표준화된 소스에서 역방향 생성 (`trim` 추가로 중복 방지)
3. **Step 2 (수정)**: 동일 스펙 concat → `-c copy` 사용 (재인코딩 불필요)
4. **Step 3 (수정)**: ping-pong 반복 → `-c copy` 사용 (재인코딩 불필요)

**주요 파라미터**:
- `-r 30`: CFR 30fps 강제
- `-g 30`: GOP 크기 30 (1초마다 keyframe, Remotion seeking 최적화)
- `-sc_threshold 0`: Scene change detection 비활성화 (일관된 GOP 보장)
- `-crf 18`: 거의 무손실 품질

#### 개선 효과

| 항목 | Before | After | 효과 |
|------|--------|-------|------|
| VFR 처리 | concat 후 재인코딩 | **먼저 CFR 변환** | ✅ 근본 해결 |
| 타임베이스 | VFR+CFR 혼합 | **완전 통일** | ✅ concat 안정성 |
| GOP 최적화 | 없음 | **-g 30 추가** | ✅ Remotion seeking |
| 처리 속도 | ~45초 (3번 재인코딩) | **~30초** (1번만) | ✅ 15초 단축 |
| 품질 | CRF 18 (2번 손실) | **CRF 18 + copy** | ✅ 손실 최소화 |

**결과**:
- ✅ 완벽한 CFR 30fps 비디오
- ✅ 영상 버벅임 완전 제거
- ✅ Remotion 렌더링 최적화
- ✅ 처리 속도 15초 단축

#### 상세 정보

자세한 분석 및 기술 설명은 [archive/error-fix-video-stuttering-vfr.md](./archive/error-fix-video-stuttering-vfr.md) 참고

---

## 참고 링크

### AI 이미지 생성
- [Google Gemini 문서](https://ai.google.dev/gemini-api/docs)

### AI 영상 생성
- [Higgsfield 문서](https://docs.higgsfield.ai/llms.txt)

### 영상 처리
- [FastPix: Video Loop](https://www.fastpix.io/blog/how-to-loop-video-playback-in-html)
- [W3Schools: Video Loop](https://www.w3schools.com/tags/att_video_loop.asp)

---

## 아카이브 기록

- [2026년 1월 아카이브](./archive/오류해결-2026-01-archived.md) - 오류 #1~#13 (13건)
- [Remotion Target Closed 에러](./archive/error-fix-remotion-target-closed.md) - 오류 #15 ✅
- [Remotion 성능 최적화](./archive/remotion-performance-optimization.md) - 오류 #16 ✅
- [영상 버벅임 문제 (VFR → CFR)](./archive/error-fix-video-stuttering-vfr.md) - 오류 #17 ✅

---

**마지막 업데이트**: 2026-01-12
