# AI 이미지 생성 디버깅 기록

## 현재 상황 (2024-01-16)

### 문제점
1. **참조 이미지가 제대로 합성되지 않음**
   - 참조 이미지(삼성 로고)를 입력했는데 한복 이미지가 나옴 (다른 테스트에서)
   - 참조 이미지의 배경이 제거되지 않음 (체크무늬 투명 배경이 그대로 보임)
   - 참조 이미지가 사각형 박스 안에 들어가 있어 자연스럽지 않음

2. **듀얼 프레임 생성 실패**
   - 좌우로 분할된 이미지가 생성되지 않음
   - 프롬프트에 지시했지만 AI가 무시함

3. **배경이 순수 검정색이 아님**
   - 프롬프트에 "#000000"을 지시했지만 골드/베이지 배경이 생성됨

---

## 원인 분석

### 1. Nano Banana Pro의 input_images 동작 방식
현재 코드:
```javascript
if (referenceImageUrl) {
  inputImages.push({
    type: 'image_url',
    image_url: referenceImageUrl
  });
}
```

**문제**: `input_images`가 "이미지 합성"이 아닌 "스타일 참조"로 동작하는 것으로 보임
- AI가 참조 이미지를 "참고"만 하거나
- 또는 이미지를 그대로 붙여넣기 함 (배경 제거 없이)

### 2. 프롬프트의 한계
현재 프롬프트:
```
첨부한 이미지는 배경을 제거한 후에 생성 될 이미지의 중앙에서 약간 위쪽으로 각각 배치해주고...
```

**문제**: AI 이미지 생성 모델은 "배경 제거"를 직접 수행하지 못함
- 프롬프트로 지시해도 AI가 이해하지 못하거나 무시함
- 참조 이미지를 그대로 사각형 박스로 붙여넣음

### 3. 듀얼 프레임 프롬프트 무시
프롬프트:
```
절반에는 똑같은 배경에 텍스트는 없는 이미지로 생성해줘.
좌우로 텍스트 있는 이미지와 없는 이미지가 배치되도록 생성해.
```

**문제**: AI가 복잡한 레이아웃 지시를 제대로 따르지 않음

---

## 해결 방안

### 방안 1: 배경 제거 API 사전 처리 (권장)
참조 이미지를 AI에 전달하기 전에 배경 제거 API로 먼저 처리

**장점**: 확실한 배경 제거
**단점**: 추가 API 비용, 처리 시간 증가

사용 가능한 배경 제거 API:
- Remove.bg API
- Photoroom API
- Clipdrop API

### 방안 2: 클라이언트 Canvas 합성
AI가 배경만 생성 → 클라이언트에서 참조 이미지를 Canvas로 직접 합성

**장점**: AI 의존도 낮음, 정확한 위치 제어
**단점**: 클라이언트 처리 필요, 자연스러운 합성 어려움

### 방안 3: 2단계 AI 생성
1단계: 배경만 생성 (참조 이미지 없이)
2단계: 생성된 배경 + 참조 이미지를 합성용 AI로 전달

**장점**: 더 자연스러운 결과 가능
**단점**: 2배의 생성 시간/비용

### 방안 4: 프롬프트 개선 (현재 시도 중)
더 명확하고 간단한 프롬프트로 AI 지시

---

## 수정 이력

### 2024-01-16 - 프롬프트 간소화
**변경 내용:**
- stylePrompts에서 구체적 오브젝트 제거
- categoryPrompts에서 구체적 오브젝트 제거
- 프롬프트를 자연스러운 한국어 문장으로 변경

**결과:** 부분적 개선, 여전히 참조 이미지 문제 존재

### 2024-01-16 - quality 파라미터 추가
**변경 내용:**
```javascript
quality: '4k',
```

**결과:** 테스트 필요

### 2024-01-16 - aspect_ratio 수정
**변경 내용:**
- 21:9 → 18:9 (실패) → 16:9

**결과:** 16:9로 동작함

---

## 다음 단계

1. [ ] input_images 파라미터가 Nano Banana Pro에서 어떻게 동작하는지 정확히 확인
2. [ ] 배경 제거 API 도입 검토
3. [ ] 2단계 생성 방식 검토 (배경 생성 → 합성)
4. [ ] 힉스필드 API 문서에서 input_images 사용법 확인

---

## 테스트 기록

### 테스트 1
- **입력**: 삼성 로고, traditional 스타일, opening 카테고리
- **결과**: 한복 이미지가 사각형 박스로 표시됨, 배경 제거 안됨
- **문제**: 참조 이미지가 제대로 처리되지 않음

### 테스트 2 (2024-01-16)
- **입력**: 삼성 로고 (파란 타원형 배경에 SAMSUNG 텍스트)
- **결과**: 삼성 로고 대신 한복 이미지가 나옴
- **심각한 문제**: 참조 이미지가 완전히 다른 이미지로 바뀜

#### 가능한 원인
1. **이전 테스트 캐시**: 이전에 한복 이미지를 테스트했고, 그게 어딘가에 캐시됨
2. **클라이언트 상태 문제**: `data.referenceImage`가 이전 값을 유지하고 있음
3. **Firebase 캐시**: 같은 경로에 이전 파일이 남아있음
4. **API 파라미터 전달 실패**: `referenceImage`가 API에 제대로 전달되지 않음

#### 디버그 로그 추가
- `generate-dual-frame/route.ts`에 상세 로그 추가
- 참조 이미지 전달 과정 추적

---

## 확인 필요 사항

1. [x] 서버 로그에서 `=== GENERATE DUAL FRAME DEBUG ===` 확인
2. [x] `Reference Image Provided:` 값 확인 → true
3. [x] `Reference Image Uploaded URL:` 값 확인 → 정상 업로드됨
4. [x] 해당 URL로 직접 접속해서 실제 이미지 확인 → 삼성 로고 맞음

---

## 원인 발견! (2024-01-16)

### input_images 구조가 틀렸음

**힉스필드 웹 UI의 실제 구조:**
```json
"input_images": [
  {
    "id": "b7abe027-65a2-4f56-b01b-347dc843bff7",
    "url": "https://...",
    "type": "media_input"
  }
]
```

**우리 코드의 구조 (틀림):**
```javascript
{
  type: 'image_url',
  image_url: referenceImageUrl
}
```

### 수정 내용
```javascript
// 변경 전
inputImages.push({
  type: 'image_url',
  image_url: referenceImageUrl
});

// 변경 후
inputImages.push({
  id: `ref-${Date.now()}`,
  url: referenceImageUrl,
  type: 'media_input'
});
```
