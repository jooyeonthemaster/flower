# AI 프롬프트 관리 문서

> 프롬프트 변경 시 이 문서를 먼저 확인하고 업데이트할 것

## 1. 프롬프트 파일 위치

| 용도 | 파일 경로 | 상태 |
|------|----------|------|
| **배경 이미지 생성** | `src/app/api/ai/generate-background/route.ts` | ✅ 신규 |
| **텍스트 프레임 생성** | `src/app/api/ai/generate-text-frame/route.ts` | ✅ 신규 |
| **영상 생성 (Start/End)** | `src/app/api/ai/generate-video-startend/route.ts` | 유지 |
| **단일 이미지 생성** | `src/app/api/ai/generate-image/route.ts` | 유지 |
| ~~듀얼 프레임 이미지 생성~~ | `src/app/api/ai/generate-dual-frame/route.ts` | ⚠️ deprecated |

---

## 2. 듀얼 프레임 이미지 프롬프트 (현재 버전)

### 2.1 목적
- 16:9 비율의 이미지 생성
- 좌측: 배경 + 3D 텍스트
- 우측: 동일 배경, 텍스트 없음
- 이후 좌우 분할하여 Start/End 프레임으로 사용

### 2.2 현재 프롬프트 구조
```
1. IMAGE LAYOUT - 16:9 좌우 분할 구조 설명
2. VISUAL STYLE - fancy/simple 스타일
3. OCCASION - 카테고리별 분위기
4. 3D TEXT STYLING - 텍스트 스타일링
5. BACKGROUND - 검은 배경 기본
6. CRITICAL RULES - 핵심 규칙 (4분할 금지, 텍스트 1회만 등)
```

### 2.3 핵심 규칙 (CRITICAL RULES 1-9)
- 텍스트는 **좌측에만 1번** 등장
- **4분할(2x2) 금지**
- **상하 분할 금지** - 반드시 좌우 분할 (세로 분할선)
- 분할선이 있다면 **검은색 + 최대한 얇게**
- 좌우 배경은 **동일**해야 함
- **레이블 텍스트 금지** - "LEFT HALF", "RIGHT HALF" 등 지시사항을 이미지에 렌더링 금지

---

## 3. 변경 이력

### 2026-01-22: AI 2회 생성 방식으로 전환 ✅ 완료
**문제**: 16:9 듀얼 프레임 이미지 생성 시 4분할 문제가 빈번하게 발생
**원인**: Gemini가 좌/우 분할 대신 2x2 그리드로 생성하는 경우가 있음
**해결**: AI 2회 생성 방식으로 전환

**새로운 플로우**:
```
1. /api/ai/generate-background 호출
   → 1:1 배경 이미지 생성 (텍스트 없음)
   → startFrameUrl 획득

2. /api/ai/generate-text-frame 호출
   → 첫 번째 이미지를 참조로 전달
   → 동일한 배경에 텍스트 추가된 1:1 이미지 생성
   → endFrameUrl 획득

3. 영상 생성 API 호출 (변경 없음)
```

**변경된 파일**:
- `src/app/api/ai/generate-background/route.ts` - 신규 생성
- `src/app/api/ai/generate-text-frame/route.ts` - 신규 생성
- `src/components/ai-hologram/steps/CompositionImagePreviewStep.tsx` - splitImage() 제거, 2회 호출 로직
- `src/app/api/ai/generate-dual-frame/route.ts` - deprecated 처리

**장점**:
- 4분할 문제 원천 차단 (1:1 이미지 직접 생성)
- splitImage() 함수 및 Canvas 로직 제거로 코드 단순화
- 각 단계 독립적이어서 디버깅 용이

**비용 영향**: 이미지 생성 비용 2배 증가 (+$0.134/씬)

---

### 2026-01-21: 레이블 텍스트 금지 규칙 추가 ✅
**문제**: AI가 "LEFT HALF", "RIGHT HALF" 등의 레이블 텍스트를 이미지에 렌더링
**원인**: 프롬프트 지시사항을 이미지 내 텍스트로 착각
**해결**:
- CRITICAL RULES 9번 추가: "Do NOT add any labels like 'LEFT HALF', 'RIGHT HALF'..."

### 2026-01-21: 상하분할 금지 규칙 추가 ✅
**문제**: AI가 좌우 분할 대신 상하 분할로 이미지 생성
**원인**: CRITICAL RULES에 상하분할 금지가 명시되어 있지 않음
**해결**:
- CRITICAL RULES 7번 추가: "NEVER split TOP and BOTTOM"
- CRITICAL RULES 8번 추가: "[LEFT: with text] | [RIGHT: no text], NOT [TOP] / [BOTTOM]"
- 폴백 로그 강화 (모니터링용)

### 2026-01-21: 프롬프트 단순화 ✅ 성공
**문제**: AI가 프롬프트를 제대로 이해하지 못해 상하 중복 텍스트, 4분할 이미지 생성
**원인**: 프롬프트가 너무 복잡함 (ASCII 다이어그램, 중복 설명)
**해결**:
- ASCII 다이어그램 제거
- 핵심 규칙만 간결하게 작성
- "텍스트 1회만", "4분할 금지" 명확히 강조
**결과**: 로컬 테스트 성공

### 2026-01-21: 분할선 규칙 변경
**문제**: 중앙에 눈에 띄는 분할선 생성
**해결**:
- 분할선이 있다면 검은색(#000000)으로
- 홀로그램에서 검은색은 투명 처리됨
- 최대한 얇게 (1px)

---

## 4. 알려진 문제점

### 4.1 배포 서버에서 4분할 빈도 높음
**원인**: 폴백 모델 사용 시 프롬프트 해석 차이
- 1차: `gemini-3-pro-image-preview`
- 2차: `gemini-2.5-flash-image`
- 3차: `imagen-3.0-generate-001`

**대응 방안**:
1. 프롬프트 강화 (현재 적용)
2. 폴백 제거 또는 제한 (미적용)
3. 4분할 감지 후 재생성 (미적용)

### 4.2 좌우 배경 불일치
**원인**: AI가 "파노라마"처럼 다른 장면을 연결
**해결**: "IDENTICAL background" 강조

---

## 5. 스타일/카테고리 설정

### 5.1 스타일 (style)
| 값 | 설명 |
|----|------|
| `fancy` | 화려함, 극적, 파티클 풍부 |
| `simple` | 미니멀, 우아함, 깔끔 |

### 5.2 카테고리 (category)
| 값 | 설명 | 분위기 |
|----|------|--------|
| `wedding` | 결혼식 | 로맨틱, 영원한 사랑 |
| `opening` | 개업 | 번영, 성공, 런칭 |
| `event` | 행사/전시 | 스포트라이트, 특별한 순간 |

---

## 6. 프롬프트 수정 가이드라인

### DO (권장)
- 핵심 규칙은 **CRITICAL RULES** 섹션에 명확히
- 금지 사항은 "Do NOT" 형태로 명시
- 변경 시 이 문서에 이력 기록

### DON'T (금지)
- ASCII 다이어그램 남용 (AI가 혼란스러워함)
- 중복 설명 (같은 내용 여러 번 반복)
- 애매한 표현 ("적당히", "알아서" 등)

---

## 7. 테스트 체크리스트

프롬프트 수정 후 확인할 사항:

- [ ] 16:9 비율로 생성되는가?
- [ ] 좌측에만 텍스트가 있는가?
- [ ] 우측에 텍스트가 없는가?
- [ ] 4분할(2x2)이 아닌가?
- [ ] 좌우 배경이 동일한가?
- [ ] 분할선이 있다면 검은색인가?
- [ ] 로컬과 배포 서버 모두 정상인가?

---

## 8. 향후 개선 계획

- [x] ~~4분할 자동 감지 로직 추가~~ → AI 2회 생성 방식으로 원천 해결
- [x] ~~감지 시 자동 재생성 (최대 3회)~~ → 불필요해짐
- [ ] 배경 일관성 모니터링 (두 이미지 간 배경 유사도 측정)
- [ ] 생성 품질 로깅 및 분석
- [ ] 비용 최적화 검토 (필요시 단일 이미지 방식 복귀 옵션)
